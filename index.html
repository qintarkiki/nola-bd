<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Nola Birthday AR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- A-Frame + MindAR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <!-- html2canvas for photo capture -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }

      .ar-container {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
      }

      a-scene {
        width: 100%;
        height: 100%;
      }

      #debug {
        position: fixed;
        left: 8px;
        bottom: 8px;
        z-index: 9999;
        padding: 4px 8px;
        font-size: 12px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #fff;
        background: rgba(0,0,0,0.5);
        border-radius: 4px;
      }

      #photo-button {
        position: fixed;
        right: 10px;
        bottom: 50px;
        z-index: 9999;
        padding: 8px 14px;
        border-radius: 999px;
        border: none;
        font-size: 14px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: rgba(255, 111, 145, 0.9);
        color: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      }

      #photo-button:disabled {
        opacity: 0.6;
      }
      #music-button {
        position: fixed;
        right: 10px;
        bottom: 95px; /* a bit above the Save photo button */
        z-index: 9999;
        padding: 8px 14px;
        border-radius: 999px;
        border: none;
        font-size: 14px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: rgba(255, 172, 143, 0.9);
        color: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      }

    </style>
  </head>

  <body>
    <div id="debug">Loading cameraâ€¦</div>
    <button id="photo-button">ðŸ“¸ Save photo</button>
    <button id="music-button">ðŸŽµ Play music</button>

    <div class="ar-container">
      <a-scene
        mindar-image="imageTargetSrc: ./assets/targets.mind; autoStart: true;"
        color-space="sRGB"
        renderer="colorManagement: true; antialias: true; alpha: true"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
      >
        <a-entity id="bgm-sound"
            sound="src: #bgm; autoplay: false; loop: true; volume: 0.4">
        </a-entity>

        <a-assets>
          <img id="couple"   src="./assets/couple.png" />
          <img id="balloon"  src="./assets/balloon.png" />
          <img id="hbd"      src="./assets/hbd.png" />
          <img id="present1" src="./assets/present-1.png" />
          <img id="present2" src="./assets/present-2.png" />
          <img id="present3" src="./assets/present-3.png" />
          <img id="star1"    src="./assets/star.png" />
          <img id="star2"    src="./assets/star-2.png" />
          <!-- new cute assets -->
          <img id="text"   src="./assets/text.png" />
          <img id="heart"    src="./assets/heart.png" />
          <img id="sparkle"  src="./assets/sparkle.png" />
          <img id="doodle1"  src="./assets/doodle1.png" />
          <img id="doodle2"  src="./assets/doodle2.png" />
          <audio id="bgm" src="./assets/music.mp4" preload="auto"></audio>

        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- All AR content -->
        <a-entity mindar-image-target="targetIndex: 0" id="ar-root">
          
          <!-- COUPLE illustration -->
          <a-plane
            src="#couple"
            width="1.4"
            height="2.0"
            position="0 0 0"
            rotation="0 0 0"
            material="transparent: true; alphaTest: 0.1"
            animation__bob="property: position; to: 0 0.05 0; dir: alternate; loop: true; dur: 1200; easing: easeInOutSine"
          ></a-plane>

          <!-- HAPPY BIRTHDAY text image -->
          <a-image
            src="#text"
            width="1.6"
            height="0.45"
            position="0 -1.35 0.1"
            rotation="-10 0 0"
            material="transparent: true; alphaTest: 0.1"
          ></a-image>

          <!-- HBD balloons and stickers above -->
          <a-image
            src="#hbd"
            width="1.7"
            height="0.6"
            position="0 1.2 0.08"
            material="transparent: true; alphaTest: 0.1"
          ></a-image>

          <!-- BALLOONS -->
          <a-image
            src="#balloon"
            width="0.6"
            height="0.9"
            position="-0.95 0.4 0.12"
            material="transparent: true; alphaTest: 0.1"
            animation="property: position; to: -0.95 0.8 0.16; dir: alternate; loop: true; dur: 1800; easing: easeInOutSine"
          ></a-image>

          <a-image
            src="#balloon"
            width="0.6"
            height="0.9"
            position="0.95 0.35 0.12"
            material="transparent: true; alphaTest: 0.1"
            animation="property: position; to: 0.95 0.75 0.16; dir: alternate; loop: true; dur: 1500; easing: easeInOutSine"
          ></a-image>

          <!-- PRESENTS -->
          <a-image
            src="#present1"
            width="0.5"
            height="0.5"
            position="-0.7 -0.6 0.05"
            rotation="0 8 0"
            material="transparent: true; alphaTest: 0.1"
            animation="property: rotation; to: 0 -8 0; dir: alternate; loop: true; dur: 1400; easing: easeInOutSine"
          ></a-image>

          <a-image
            src="#present2"
            width="0.5"
            height="0.5"
            position="0.4 -0.7 0.02"
            material="transparent: true; alphaTest: 0.1"
            animation="property: scale; to: 1.15 1.15 1; dir: alternate; loop: true; dur: 1300; easing: easeInOutSine"
          ></a-image>

          <a-image
            src="#present3"
            width="0.5"
            height="0.5"
            position="0.9 -0.6 -0.05"
            rotation="0 -8 0"
            material="transparent: true; alphaTest: 0.1"
            animation="property: rotation; to: 0 8 0; dir: alternate; loop: true; dur: 1500; easing: easeInOutSine"
          ></a-image>

          <!-- SPARKLES -->
          <a-image
            src="#sparkle"
            width="0.22"
            height="0.22"
            position="-0.6 1.0 0.15"
            material="transparent: true; alphaTest: 0.1"
            animation="property: scale; to: 1.4 1.4 1; dir: alternate; loop: true; dur: 1000;"
          ></a-image>

          <a-image
            src="#sparkle"
            width="0.22"
            height="0.22"
            position="0.6 1.05 0.15"
            material="transparent: true; alphaTest: 0.1"
            animation="property: scale; to: 1.4 1.4 1; dir: alternate; loop: true; dur: 1100;"
          ></a-image>

          <!-- FLOATING HEARTS (ONLY LEFT & RIGHT â€” middle removed) -->
          <a-image
            src="#heart"
            width="0.3"
            height="0.3"
            position="-0.45 0.15 0.18"
            material="transparent: true; alphaTest: 0.1"
            animation__rise="property: position; to: -0.45 0.7 0.18; dir: alternate; loop: true; dur: 2000;"
            animation__scale="property: scale; to: 1.3 1.3 1; dir: alternate; loop: true; dur: 2000;"
          ></a-image>

          <a-image
            src="#heart"
            width="0.25"
            height="0.25"
            position="0.45 0.1 0.18"
            material="transparent: true; alphaTest: 0.1"
            animation__rise="property: position; to: 0.45 0.65 0.18; dir: alternate; loop: true; dur: 2200;"
            animation__scale="property: scale; to: 1.4 1.4 1; dir: alternate; loop: true; dur: 2200;"
          ></a-image>

          <!-- CUTE DOODLES (e.g., sushi & swirl) -->
          <a-image
            src="#doodle1"
            width="0.4"
            height="0.4"
            position="-1.0 -0.3 -0.05"
            material="transparent: true; alphaTest: 0.1"
            animation="property: rotation; to: 0 0 5; dir: alternate; loop: true; dur: 1700;"
          ></a-image>

          <a-image
            src="#doodle2"
            width="0.4"
            height="0.4"
            position="1.0 -0.3 0.05"
            material="transparent: true; alphaTest: 0.1"
            animation="property: rotation; to: 0 0 -5; dir: alternate; loop: true; dur: 1800;"
          ></a-image>
        </a-entity>
      </a-scene>
    </div>

    <script>
      const debug = document.getElementById('debug');
      const scene = document.querySelector('a-scene');
      const target = document.getElementById('ar-root');
      const photoBtn = document.getElementById('photo-button');

      const musicBtn = document.getElementById('music-button');
      const bgmEntity = document.querySelector('#bgm-sound');
      let musicOn = false;

      musicBtn.addEventListener('click', () => {
        if (!bgmEntity || !bgmEntity.components || !bgmEntity.components.sound) return;

        if (!musicOn) {
          bgmEntity.components.sound.playSound();
          musicBtn.textContent = 'ðŸ”‡ Stop music';
        } else {
          bgmEntity.components.sound.stopSound();
          musicBtn.textContent = 'ðŸŽµ Play music';
        }
        musicOn = !musicOn;
      });


      window.addEventListener('load', () => {
        debug.textContent = 'Point to the printed picture ðŸŽ¯';
      });

      // Confetti burst when target found
      function spawnConfetti() {
        const parent = document.getElementById('ar-root');
        if (!parent) return;

        const confettiGroup = document.createElement('a-entity');
        confettiGroup.setAttribute('id', 'confetti-group');
        parent.appendChild(confettiGroup);

        const colors = ['#FFC700', '#FF4D6A', '#6BCB77', '#4D96FF', '#FFB5E8'];

        for (let i = 0; i < 28; i++) {
          const piece = document.createElement('a-plane');
          piece.setAttribute('width', '0.06');
          piece.setAttribute('height', '0.12');
          piece.setAttribute('material', `color: ${colors[i % colors.length]}; side: double;`);

          const x = (Math.random() * 2 - 1) * 1.1;
          const yStart = 1.3 + Math.random() * 0.4;
          const z = -0.1 + Math.random() * 0.2;
          piece.setAttribute('position', `${x} ${yStart} ${z}`);

          const rot = `${Math.random() * 360} ${Math.random() * 360} ${Math.random() * 360}`;
          piece.setAttribute('rotation', rot);

          const yEnd = -0.5 - Math.random() * 0.3;
          const dur = 1200 + Math.random() * 800;

          piece.setAttribute('animation__fall',
            `property: position; to: ${x} ${yEnd} ${z}; dur: ${dur}; easing: ease-in;`);
          piece.setAttribute('animation__spin',
            'property: rotation; to: 0 0 360; dur: 800; loop: true; easing: linear;');

          confettiGroup.appendChild(piece);
        }

        setTimeout(() => {
          if (confettiGroup.parentNode) {
            confettiGroup.parentNode.removeChild(confettiGroup);
          }
        }, 2200);
      }

      scene.addEventListener('arReady', () => {
        debug.textContent = 'AR ready â€“ point to the printed picture ðŸŽ¯';
      });

      scene.addEventListener('arError', (e) => {
        debug.textContent = 'AR error: ' + JSON.stringify(e.detail || {});
      });

      if (target) {
        target.addEventListener('targetFound', () => {
          debug.textContent = 'Target FOUND ðŸŽ‰';
          spawnConfetti();
          if (!hasStartedOnce && bgmEntity && bgmEntity.components.sound) {
            const musicBtn = document.getElementById('music-button');
            const bgmEntity = document.querySelector('#bgm-sound');
            let musicOn = false;
            let hasStartedOnce = false;
          }
        });
        target.addEventListener('targetLost', () => {
          debug.textContent = 'Target lost â€“ move closer ðŸ‘€';
        });
      }

      // Photo button: capture whole screen and download
      photoBtn.addEventListener('click', async () => {
        photoBtn.disabled = true;
        photoBtn.textContent = 'Savingâ€¦';

        try {
          const canvas = await html2canvas(document.body, {useCORS: true});
          const link = document.createElement('a');
          link.download = 'birthday-ar.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        } catch (err) {
          console.error(err);
          alert('Sorry, this device does not allow screenshot capture.');
        }

        photoBtn.disabled = false;
        photoBtn.textContent = 'ðŸ“¸ Save photo';
      });
    </script>
  </body>
</html>
